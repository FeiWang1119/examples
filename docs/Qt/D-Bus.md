# Qt `D-Bus`

`D-Bus` 是一种进程间通信 （IPC） 和远程过程调用 （RPC） 机制，最初是为 Linux 开发的，用于用一个统一的协议替换现有和竞争的 IPC 解决方案。它还设计为允许系统级进程（如打印机和硬件驱动程序服务）与正常用户进程之间的通信。

它使用快速的二进制消息传递协议，由于其低延迟和低开销，适用于同机通信。其规范目前由 freedesktop.org 项目定义，可供各方使用。

通信通常通过称为“总线”（因此得名）的中央服务器应用程序进行，但也可以进行直接的应用程序到应用程序通信。在总线上通信时，应用程序可以查询哪些其他应用程序和服务可用，并按需激活一个。

## The Buses

`D-Bus` 总线用于需要多对多通信的情况。为了实现这一点，在任何应用程序连接到总线之前启动一个中央服务器：该服务器负责跟踪连接的应用程序，并将消息从其源正确路由到目的地。

此外，`D-Bus` 定义了两条众所周知的总线，称为系统总线和会话总线。这些总线的特殊之处在于它们具有明确定义的语义：某些服务被定义为在这些总线中的一个或两个中找到。

例如，希望查询连接到计算机的硬件设备列表的应用程序可能会与系统总线上可用的服务进行通信，而提供打开用户 Web 浏览器的服务可能会在会话总线上找到。

在系统总线上，还可以期望找到每个应用程序允许提供的服务的限制。因此，可以合理地确定，如果存在某个服务，则它是由受信任的应用程序提供的。

## Concepts

### Messages

在低级别，应用程序通过相互发送消息通过 `D-Bus` 进行通信。消息用于中继远程过程调用以及与之关联的回复和错误。当通过总线使用时，消息具有目的地，这意味着它们仅路由到感兴趣的各方，避免由于“蜂拥”或广播而导致拥堵。

然而，一种称为“信号消息”（基于Qt信号和槽机制的概念）的特殊消息没有预定义的目的地。由于其目的是在一对多上下文中使用，因此信号消息旨在通过“选择加入”机制工作。

Qt `D-Bus`模块将消息的低级概念完全封装到Qt开发人员熟悉的更简单的面向对象的方法中。在大多数情况下，开发人员不必担心发送或接收消息。

### Service Names

当通过总线进行通信时，应用程序会获得所谓的“服务名称”：这是该应用程序选择被同一总线上的其他应用程序知道的方式。服务名称由 `D-Bus` 总线守护程序代理，用于将消息从一个应用程序路由到另一个应用程序。与服务名称类似的概念是 IP 地址和主机名：计算机通常有一个 IP 地址，并且根据它向网络提供的服务，可能具有一个或多个与之关联的主机名。

另一方面，如果不使用总线，也不会使用服务名称。如果我们再次将其与计算机网络进行比较，这将等同于点对点网络：由于对等体是已知的，因此无需使用主机名来查找它或其 IP 地址。

`D-Bus` 服务名称的格式实际上与主机名非常相似：它是字母和数字的点分隔序列。通常的做法是根据定义该服务的组织的域名来命名一个人的服务名称。

例如，`D-Bus` 服务由freedesktop.org 定义 ，并且可以在总线上的服务名称下找到：

```sh
org.freedesktop.DBus
```

### Object Paths

与网络主机一样，应用程序通过导出对象向其他应用程序提供特定服务。这些对象是分层组织的，很像类派生的父子关系。然而，一个区别是存在“根对象”的概念，即所有对象都具有作为最终父对象。

如果我们继续与 Web 服务进行类比，对象路径等同于 URL 的路径部分：

ftp://ftp.example.com/pub/something/

与它们一样，`D-Bus` 中的对象路径的形成类似于文件系统上的路径名：它们是斜杠分隔的标签，每个标签由字母、数字和下划线字符 （“”） 组成。它们必须始终以斜杠开头，而不能以斜杠结尾。

### Interfaces

接口类似于C++抽象类和Java的 interface 关键字，并声明在调用方和被调用方之间建立的“契约”。也就是说，它们建立了可用的方法、信号和属性的名称，以及建立通信时任何一方预期的行为。

Qt在其中使用了非常相似的机制：C++中的基类通过（）宏与唯一标识符相关联。

事实上，`D-Bus`接口名称的命名方式类似于Qt插件系统的建议：通常由定义该接口的实体的域名构造的标识符。

### Cheat Sheet

为了便于记住命名格式及其用途，可以使用下表：

|`D-Bus` Concept |Analogy|	Name format|
|--|--|--|
|Service name | Network hostnames | Dot-separated ("looks like a hostname")|
|Object path | URL path component | Slash-separated ("looks like a path") |
|Interface | Plugin identifier | Dot-separated|

## Debugging

在开发使用 `D-Bus` 的应用程序时，有时能够查看有关每个应用程序通过总线发送和接收的消息的信息很有用。

通过在运行每个应用程序之前设置 QDBUS_DEBUG 环境变量，可以基于每个应用程序启用此功能。例如，我们可以通过通过以下方式运行控制器和汽车来仅为汽车启用调试：

```sh
examples/dbus/remotecontrolledcar/controller/controller &
QDBUS_DEBUG=1 examples/dbus/remotecontrolledcar/car/car &
```

有关消息的信息将写入启动应用程序的控制台。
